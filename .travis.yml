env:
  matrix:
    - NETBSD_VERSION=6.0
    - NETBSD_VERSION=6.0.5
    - NETBSD_VERSION=6.1
    - NETBSD_VERSION=6.1.5
    - NETBSD_VERSION=7.0
    - NETBSD_VERSION=7.1.2
    - NETBSD_VERSION=8.0

sudo: required

language: perl

perl:
  - "5.22"

services:
  - docker

install: true

before_install:
  - source <(curl https://raw.githubusercontent.com/madworx/cd-ci-glue/add-aws-ecr-functionality/src/cd-ci-glue.bash)

script: true

stages:
  - build
  - test
  - publish

jobs:
  include:
    - stage: build
      script:
        - make build
        - aws_ecr_push madworx/netbsd:${NETBSD_VERSION}-x86_64 netbsd/build-${TRAVIS_BUILD_NUMBER}
    - stage: test
      script:
        - DOCKER_IMAGE=$(aws_ecr_get_image_path netbsd/build-${TRAVIS_BUILD_NUMBER}) make tests
    - stage: publish
        - is_travis_master_push &&
          docker tag $(aws_ecr_get_image_path netbsd/build-${TRAVIS_BUILD_NUMBER}) madworx/netbsd:${NETBSD_VERSION}-x86_64 &&
          dockerhub_push_image madworx/netbsd:${NETBSD_VERSION}-x86_64 || true
    - stage: Update DockerHub description
      env: NETBSD_VERSION
      script:
        - is_travis_master_push &&
          dockerhub_set_description madworx/netbsd README.md || true

after_success:
  - is_travis_master_push &&
    dockerhub_push_image madworx/netbsd:${NETBSD_VERSION}-x86_64
